import arcpyimport pandas as pdimport matplotlib.pyplot as pltimport os# -----------------------------# TOOLBOX CLASS# -----------------------------class Toolbox(object):    def __init__(self):        self.label = "Census Toolbox"        self.alias = "censustools"        self.tools = [CensusJoinTool]# -----------------------------# TOOL CLASS# -----------------------------class CensusJoinTool(object):    def __init__(self):        self.label = "Census Join and Map"        self.description = "Join Census CSV to GeoJSON, symbolize, and plot."        self.canRunInBackground = False    def getParameterInfo(self):        # CSV input        param_csv = arcpy.Parameter(            displayName="Select Census CSV File",            name="csv_file",            datatype="DEFile",            parameterType="Required",            direction="Input")        # GeoJSON input        param_json = arcpy.Parameter(            displayName="Select Census GeoJSON File",            name="geojson_file",            datatype="DEFile",            parameterType="Required",            direction="Input")        # Output folder        param_output = arcpy.Parameter(            displayName="Choose Output Folder",            name="output_folder",            datatype="DEFolder",            parameterType="Required",            direction="Input")        # Attribute field        param_attribute = arcpy.Parameter(            displayName="Attribute Field Name (EXACT)",            name="attribute_field",            datatype="GPString",            parameterType="Required",            direction="Input")        param_attribute.value = "Total"        # Symbology (dropdown)        param_symbology = arcpy.Parameter(            displayName="Symbology Type",            name="symbology_type",            datatype="GPString",            parameterType="Required",            direction="Input")        param_symbology.filter.type = "ValueList"        param_symbology.filter.list = ["Graduated Colors"]        param_symbology.value = "Graduated Colors"        return [param_csv, param_json, param_output, param_attribute, param_symbology]    def execute(self, parameters, messages):        arcpy.env.overwriteOutput = True        csv_file = parameters[0].valueAsText        geojson_file = parameters[1].valueAsText        output_folder = parameters[2].valueAsText        attribute_field = parameters[3].valueAsText        # -----------------------------        # Validate GeoJSON file        # -----------------------------        if not geojson_file.lower().endswith(".geojson"):            raise arcpy.ExecuteError("ERROR: The selected file is not a .geojson file.")        if not os.path.exists(geojson_file):            raise arcpy.ExecuteError("ERROR: GeoJSON file not found at the specified path.")        # -----------------------------        # Ensure output folder exists        # -----------------------------        if not os.path.exists(output_folder):            os.makedirs(output_folder)        # Safe output paths        output_fc = os.path.join(output_folder, "StoryCounty_Output.shp")        temp_csv = os.path.join(output_folder, "cleaned_census.csv")        png_output = os.path.join(output_folder, f"{attribute_field}_bar_chart.png")        # -----------------------------        # Read and clean CSV        # -----------------------------        arcpy.AddMessage("Loading CSV file...")        df = pd.read_csv(csv_file)        df.columns = df.columns.str.strip()  # Remove whitespace        # Verify attribute field exists        if attribute_field not in df.columns:            raise arcpy.ExecuteError(                f"Attribute field '{attribute_field}' not found in CSV. Columns are: {df.columns.tolist()}"            )        # Define join fields        join_field_csv = "Label (Grouping)"  # adjust if necessary        join_field_geo = "NAME"  # adjust if necessary        # Verify join field exists        if join_field_csv not in df.columns:            raise arcpy.ExecuteError(                f"CSV join field '{join_field_csv}' not found. Columns are: {df.columns.tolist()}"            )        df.to_csv(temp_csv, index=False)        # -----------------------------        # Convert GeoJSON â†’ Feature Class        # -----------------------------        arcpy.AddMessage("Converting GeoJSON to Feature Class...")        try:            arcpy.conversion.JSONToFeatures(geojson_file, output_fc)        except arcpy.ExecuteError:            raise arcpy.ExecuteError("ERROR: Failed to convert GeoJSON to features. "                                     "Make sure the file is a valid FeatureCollection GeoJSON.")        # -----------------------------        # Make Feature Layer and Join CSV        # -----------------------------        arcpy.AddMessage("Creating feature layer...")        layer = arcpy.management.MakeFeatureLayer(output_fc, "output_layer")        arcpy.AddMessage("Loading CSV table into ArcGIS...")        csv_table = arcpy.management.MakeTableView(temp_csv, "csv_table")        arcpy.AddMessage("Joining CSV to GeoJSON features...")        arcpy.management.AddJoin(            in_layer_or_view=layer,            in_field=join_field_geo,            join_table=csv_table,            join_field=join_field_csv,            join_type="KEEP_COMMON"        )        # -----------------------------        # Create Bar Graph        # -----------------------------        arcpy.AddMessage("Creating bar chart PNG...")        plt.figure(figsize=(12, 7))        plt.bar(df[join_field_csv], df[attribute_field])        plt.xticks(rotation=90)        plt.title(f"Census Data - {attribute_field}")        plt.xlabel("Census Tract")        plt.ylabel(attribute_field)        plt.tight_layout()        plt.savefig(png_output)        plt.close()        # -----------------------------        # Finish        # -----------------------------        arcpy.AddMessage(f"SUCCESS! Output shapefile created at: {output_fc}")        arcpy.AddMessage(f"PNG saved to: {png_output}")        arcpy.AddMessage("Process complete!")